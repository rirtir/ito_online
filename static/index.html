<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lobby / Game / Watch Demo</title>
  <style>
    body { font-family: sans-serif; padding: 12px; }
    #controls > * { margin-right: 6px; }
    .hidden { display: none; }
    #log { margin-top: 12px; border-top: 1px solid #ddd; padding-top: 8px; max-height: 240px; overflow:auto; }
    .slot { margin: 2px 0; }
    .area { margin-top: 12px; padding: 8px; border: 1px solid #eee; border-radius: 6px; }
    button { padding: 6px 10px; }

    body {
      font-family: "Segoe UI", "Hiragino Sans", sans-serif;
      padding: 2vh 3vw;
      background: #f5f7fa;
      color: #333;
      font-size: 1.2vw;
    }

    h2 {
      margin-bottom: 1vh;
      font-size: 2vw;
      color: #2c3e50;
    }

    .area {
      margin-top: 2vh;
      padding: 2vh 2vw;
      border: 0.2vw solid #ddd;
      border-radius: 1vw;
      background: #fff;
      box-shadow: 0 0.5vh 1vh rgba(0,0,0,0.05);
    }

    #controls {
      margin-bottom: 2vh;
    }

    button {
      padding: 1vh 2vw;
      border: none;
      border-radius: 0.8vw;
      background: #3498db;
      color: #fff;
      font-size: 1vw;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      background: #2980b9;
    }

    button:active {
      transform: scale(0.95);
    }

    button.hidden {
      display: none;
    }

    #myInfo {
      margin: 1.5vh 0;
      font-weight: bold;
      font-size: 1.2vw;
      color: #27ae60;
    }

    #slots h4 {
      margin-bottom: 1vh;
      font-size: 1.3vw;
      color: #444;
    }

    .slot {
      padding: 0.8vh 1vw;
      margin: 0.8vh 0;
      border-radius: 0.6vw;
      background: #ecf0f1;
      font-size: 1vw;
      transition: background 0.2s;
    }

    .slot:hover {
      background: #dfe6e9;
    }

    #log {
      margin-top: 2vh;
      border-top: 0.2vw solid #ccc;
      padding-top: 1vh;
      max-height: 30vh;
      overflow: auto;
      font-family: monospace;
      font-size: 1vw;
      background: #1e272e;
      color: #dcdde1;
      border-radius: 0.6vw;
    }

    #log div {
      padding: 0.3vh 0;
    }

    @media screen and (orientation: portrait) {
      
      body {
        font-size: 4vw;
      }
      
      h2 {
        font-size: 8vw;
      }

      button {
        font-size: 4vw;
      }

      button.hidden {
        display: none;
      }

      #myInfo {
        font-size: 3vw;
      }

      #slots h4 {
        font-size: 5vw;
      }

      .slot {
        font-size: 3vw;
      }

      #log {
        font-size: 3vw;
      }
    }

  </style>
</head>
<body>
  <h2>ロビー</h2>

  <div id="lobby" class="area">
    <p>現在のモード: <span id="mode">ロビー</span></p>
    <div id="controls">
      <button id="enterGameBtn">ゲームエリアに入る</button>
      <button id="enterWatchBtn">観戦エリアに入る</button>
      <button id="leaveGameBtn" class="hidden">ゲームエリアを抜ける</button>
      <button id="leaveWatchBtn" class="hidden">観戦エリアを抜ける</button>
    </div>

    <div id="myInfo"></div>

    <div id="slots" style="margin-top:8px;">
      <h4>参加プレイヤー（スロット）</h4>
      <div id="slotList">—</div>
    </div>

    <div id="gameControls" style="margin-top:8px;">
      <button id="startBtn" class="hidden">ゲーム開始（1Pのみ開始可能）</button>
    </div>
  </div>

  <div id="log" aria-live="polite"></div>

  <script>
    // UID は localStorage に保存
    let uid = localStorage.getItem("player_uid");
    const wsBase = (() => {
      // 適宜サーバーURLに変更してください（http(s) -> ws(s)）
      const origin = location.origin;
      if (origin.startsWith("https://")) return "wss://" + location.host + "/ws";
      if (origin.startsWith("http://")) return "ws://" + location.host + "/ws";
      return "ws://localhost:10000/ws";
    })();
    let wsUrl = wsBase + (uid ? ("?uid=" + uid) : "");
    const ws = new WebSocket(wsUrl);

    const modeSpan = document.getElementById("mode");
    const enterGameBtn = document.getElementById("enterGameBtn");
    const enterWatchBtn = document.getElementById("enterWatchBtn");
    const leaveGameBtn = document.getElementById("leaveGameBtn");
    const leaveWatchBtn = document.getElementById("leaveWatchBtn");
    const myInfo = document.getElementById("myInfo");
    const slotList = document.getElementById("slotList");
    const logDiv = document.getElementById("log");
    const startBtn = document.getElementById("startBtn");

    let mySlot = null;
    let inGameArea = false;
    let inWatchArea = false;
    let gameStarted = false;

    function log(text) {
      const p = document.createElement("div");
      p.textContent = text;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateUIMode() {
      if (inGameArea) {
        modeSpan.textContent = "ゲームエリア";
        enterGameBtn.classList.add("hidden");
        enterWatchBtn.classList.add("hidden");
        leaveGameBtn.classList.remove("hidden");
        leaveWatchBtn.classList.add("hidden");
      } else if (inWatchArea) {
        modeSpan.textContent = "観戦";
        enterGameBtn.classList.add("hidden");
        enterWatchBtn.classList.add("hidden");
        leaveGameBtn.classList.add("hidden");
        leaveWatchBtn.classList.remove("hidden");
      } else {
        modeSpan.textContent = "ロビー";
        enterGameBtn.classList.remove("hidden");
        enterWatchBtn.classList.remove("hidden");
        leaveGameBtn.classList.add("hidden");
        leaveWatchBtn.classList.add("hidden");
      }
      // start ボタンは 1P かつゲーム未開始でゲームエリアにいる場合のみ表示
      if (mySlot === "1P" && inGameArea && !gameStarted) {
        startBtn.classList.remove("hidden");
      } else {
        startBtn.classList.add("hidden");
      }
    }


    ws.onopen = () => {
      log("WebSocket 接続");
      // 初期はロビー（特に何もしない）
      ws.send(JSON.stringify({type: "JOIN_LOBBY"}));
    };

    ws.onmessage = (ev) => {
      const msg = JSON.parse(event.data);
      log("RECV: " + msg.type);

      if (msg.type === "ASSIGN_ID") {
        uid = msg.user_id;
        localStorage.setItem("player_uid", uid);
        log("UID を保存しました: " + uid);
        return;
      }
      if (msg.type === "CONNECTED") {
        return;
      }
      if (msg.type === "JOINED") {
        const slot = msg.slot;
        mySlot = slot;
        myInfo.innerHTML = `<p>あなたは <b>${slot}</b> です</p>`;
        inGameArea = true;
        inWatchArea = false;
        updateUIMode();
        return;
      }
      if (msg.type === "ONLY_SPECTATOR") {
        // サーバがゲーム開始後にゲームエリア入室を拒否した場合
        alert("現在のゲームは進行中です。観戦に切り替えます。");
        inGameArea = false;
        mySlot = null;
        updateUIMode();
        return;
      }
      if (msg.type === "SLOTS") {
        try {
          const arr = msg.slots_info;
          // arr は {slot, uid} の配列
          slotList.innerHTML = "";
          arr.forEach(o => {
            const div = document.createElement("div");
            div.className = "slot";
            div.textContent = `${o.slot} — ${o.uid}${o.uid === uid ? " (あなた)" : ""}`;
            slotList.appendChild(div);
          });
          if (arr.length === 0) slotList.innerHTML = "（空）";
          const mine = arr.find(o => o.uid === uid);
          if (mine) {
            mySlot = mine.slot;
            myInfo.innerHTML = `<p>あなたは <b>${mySlot}</b> です</p>`;
          }
          updateUIMode();
        } catch (e) {
          slotList.innerHTML = "（表示エラー）";
        }
        return;
      }
      if (msg.type === "GAME_START") {
        gameStarted = true;

        // 例: game.html?user_id=123&slot=2
        const url = `${msg.url}?user_id=${msg.user_id}&slot=${msg.slot}&len_slot=${msg.len_slot}`;
        window.location.href = url;
        
        log("ゲーム開始通知を受け取りました");
        updateUIMode();
        // ゲーム開始後は観戦者は観戦のみ可能；必要なら UI を追加
        return;
      }
      if (msg.type === "PLAYER_DISCONNECTED") {
        // someone disconnected after start (keeps slot)
        return;
      }
      if (msg.type === "PLAYER_LEFT") {
        // someone left after start (but we treat similarly)
        return;
      }
      if (msg.type === "FULL") {
        alert("満員のため参加できません");
        return;
      }
      // その他メッセージはログ表示
    };

    ws.onclose = () => {
      log("接続が切れました");
    };

    // UI handlers
    enterGameBtn.onclick = () => {
      if (gameStarted) {
        // 既に開始中なら観戦へ誘導
        if (!confirm("ゲームは既に開始しています。観戦しますか？")) return;
        ws.send(JSON.stringify({type: "ENTER_SPECTATE"}));
        inGameArea = false;
        inWatchArea = true;
      } else {
        ws.send(JSON.stringify({type: "ENTER_GAME"}));
      }
    };

    enterWatchBtn.onclick = () => {
      ws.send(JSON.stringify({type: "ENTER_SPECTATE"}));
      myInfo.innerHTML = ``;
      inWatchArea = true;
      inGameArea = false;
      mySlot = null;
      updateUIMode();
    };

    leaveGameBtn.onclick = () => {
      ws.send(JSON.stringify({type: "LEAVE_GAME"}));
      myInfo.innerHTML = ``;
      mySlot = null;
      inGameArea = false;
      updateUIMode();
    };

    leaveWatchBtn.onclick = () => {
      // 単にロビー表示に戻る（接続は維持）
      myInfo.innerHTML = ``;
      inWatchArea = false;
      updateUIMode();
    };

    startBtn.onclick = () => {
      if (!confirm("本当にゲームを開始しますか？")) return;
      ws.send(JSON.stringify({type: "START"}));
    };

    // ページを閉じる際に（ゲーム未開始でゲームエリアにいる場合）明示的に leave を送っておくと
    // サーバ側で即座に繰り上げ処理される（ネットワーク切断だけだと disconnect 時に処理される）。
    window.addEventListener("beforeunload", () => {
      try {
        if (inGameArea && !gameStarted) {
          ws.send(JSON.stringify({type: "LEAVE_GAME"}));
        }
      } catch (e) {}
    });

  </script>
</body>
</html>
